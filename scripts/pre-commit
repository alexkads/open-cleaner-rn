#!/bin/bash

# Pre-commit hook para prevenir conflitos E ENFORÃ‡AR PNPM
# Instalar: cp scripts/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

echo "ğŸ” Verificando antes do commit..."

# ğŸš¨ VERIFICAR USO EXCLUSIVO DE PNPM
echo "ğŸš¨ Verificando uso exclusivo de pnpm..."

# Verificar se hÃ¡ package-lock.json ou yarn.lock
if [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
    echo "âŒ ERRO: Encontrados lockfiles de npm/yarn!"
    echo "ğŸš« Este projeto usa EXCLUSIVAMENTE pnpm"
    echo "ğŸ”§ Execute: rm package-lock.json yarn.lock && pnpm install"
    exit 1
fi

if [ -f "docs-astro/package-lock.json" ] || [ -f "docs-astro/yarn.lock" ]; then
    echo "âŒ ERRO: Encontrados lockfiles de npm/yarn em docs-astro!"
    echo "ğŸš« Este projeto usa EXCLUSIVAMENTE pnpm"
    echo "ğŸ”§ Execute: cd docs-astro && rm package-lock.json yarn.lock && pnpm install"
    exit 1
fi

# Verificar se node_modules foi criado pelo pnpm
if [ -d "node_modules" ] && [ ! -f "pnpm-lock.yaml" ]; then
    echo "âŒ ERRO: node_modules existe mas nÃ£o hÃ¡ pnpm-lock.yaml"
    echo "ğŸš« Parece que npm/yarn foi usado"
    echo "ğŸ”§ Execute: rm -rf node_modules && pnpm install"
    exit 1
fi

# Verificar se hÃ¡ comandos npm/yarn em workflows
if grep -r "npm \|yarn " .github/workflows/ --exclude-dir=.git 2>/dev/null; then
    echo "âŒ ERRO: Encontrados comandos npm/yarn em workflows!"
    echo "ğŸš« Use apenas pnpm em CI/CD"
    echo "ğŸ”§ Substitua por comandos pnpm"
    exit 1
fi

echo "âœ… VerificaÃ§Ã£o pnpm OK - apenas pnpm sendo usado"

# Verificar se hÃ¡ conflitos nÃ£o resolvidos
if grep -r "<<<<<<< HEAD" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=target; then
    echo "âŒ Encontrados marcadores de conflito nÃ£o resolvidos!"
    echo "ğŸ› ï¸  Resolva os conflitos antes de fazer commit"
    exit 1
fi

# Verificar se package-lock.json e pnpm-lock.yaml estÃ£o sincronizados
if [ -f "package-lock.json" ] && [ -f "pnpm-lock.yaml" ]; then
    echo "âš ï¸  Aviso: package-lock.json e pnpm-lock.yaml presentes"
    echo "ğŸ’¡ Considere usar apenas um gerenciador de pacotes"
fi

# Verificar formataÃ§Ã£o de arquivos importantes
echo "ğŸ“ Verificando formataÃ§Ã£o..."

# Verificar YAML syntax nos workflows
for file in .github/workflows/*.yml .github/workflows/*.yaml; do
    if [ -f "$file" ]; then
        if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo "âŒ Erro de sintaxe YAML em: $file"
            exit 1
        fi
    fi
done

# Verificar JSON syntax
for file in *.json src/**/*.json docs-astro/**/*.json; do
    if [ -f "$file" ]; then
        if ! python -c "import json; json.load(open('$file'))" 2>/dev/null; then
            echo "âŒ Erro de sintaxe JSON em: $file"
            exit 1
        fi
    fi
done

echo "âœ… VerificaÃ§Ãµes OK - prosseguindo com commit"
