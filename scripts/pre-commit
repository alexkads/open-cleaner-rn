#!/bin/bash

# Pre-commit hook para prevenir conflitos e ENFORÃ‡AR NPM
# Instalar: cp scripts/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

echo "ğŸ” Verificando antes do commit..."

# ğŸ“¦ VERIFICAR USO PADRONIZADO DE NPM
echo "ğŸ“¦ Verificando padronizaÃ§Ã£o npm..."

# Verificar se hÃ¡ pnpm-lock.yaml ou yarn.lock
if [ -f "pnpm-lock.yaml" ] || [ -f "yarn.lock" ]; then
    echo "âŒ ERRO: Encontrados lockfiles de pnpm/yarn!"
    echo "ğŸ“¦ Este projeto usa EXCLUSIVAMENTE npm"
    echo "ğŸ”§ Execute: rm pnpm-lock.yaml yarn.lock && npm install"
    exit 1
fi

if [ -f "docs-astro/pnpm-lock.yaml" ] || [ -f "docs-astro/yarn.lock" ]; then
    echo "âŒ ERRO: Encontrados lockfiles de pnpm/yarn em docs-astro!"
    echo "ğŸ“¦ Este projeto usa EXCLUSIVAMENTE npm"
    echo "ğŸ”§ Execute: cd docs-astro && rm pnpm-lock.yaml yarn.lock && npm install"
    exit 1
fi

# Verificar se hÃ¡ package-lock.json (deve ter)
if [ ! -f "package-lock.json" ]; then
    echo "âŒ ERRO: package-lock.json nÃ£o encontrado na raiz"
    echo "ğŸ”§ Execute: npm install"
    exit 1
fi

if [ ! -f "docs-astro/package-lock.json" ]; then
    echo "âŒ ERRO: package-lock.json nÃ£o encontrado em docs-astro"
    echo "ğŸ”§ Execute: cd docs-astro && npm install"
    exit 1
fi

# Verificar se hÃ¡ comandos pnpm/yarn em workflows
if grep -r "pnpm \|yarn " .github/workflows/ --exclude-dir=.git 2>/dev/null; then
    echo "âŒ ERRO: Encontrados comandos pnpm/yarn em workflows!"
    echo "ğŸ“¦ Use apenas npm em CI/CD"
    echo "ğŸ”§ Substitua por comandos npm"
    exit 1
fi

echo "âœ… VerificaÃ§Ã£o npm OK - apenas npm sendo usado"

# Verificar se hÃ¡ conflitos nÃ£o resolvidos
if grep -r "<<<<<<< HEAD" . --exclude-dir=.git --exclude-dir=node_modules --exclude-dir=target; then
    echo "âŒ Encontrados marcadores de conflito nÃ£o resolvidos!"
    echo "ğŸ› ï¸  Resolva os conflitos antes de fazer commit"
    exit 1
fi

# Verificar formataÃ§Ã£o de arquivos importantes
echo "ğŸ“ Verificando formataÃ§Ã£o..."

# Verificar YAML syntax nos workflows
for file in .github/workflows/*.yml .github/workflows/*.yaml; do
    if [ -f "$file" ]; then
        if ! python -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
            echo "âŒ Erro de sintaxe YAML em: $file"
            exit 1
        fi
    fi
done

# Verificar JSON syntax
for file in *.json src/**/*.json docs-astro/**/*.json; do
    if [ -f "$file" ]; then
        if ! python -c "import json; json.load(open('$file'))" 2>/dev/null; then
            echo "âŒ Erro de sintaxe JSON em: $file"
            exit 1
        fi
    fi
done

echo "âœ… VerificaÃ§Ãµes OK - prosseguindo com commit"
